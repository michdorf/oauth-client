function e(e,t={}){var s=new XMLHttpRequest,r=t.method||"GET",i=function(e){if("string"==typeof e)return e;var t="";for(let o in e)"object"==typeof e[o]&&(e[o]=JSON.stringify(e[o])),t+="&"+o+"="+e[o];return t.substr(1)}(t.data||"");if("cache"in s&&(s.cache=!1),void 0!==t.withCredentials&&(s.withCredentials=!!t.withCredentials),s.open(r,e),t.formEncoded&&s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),"object"==typeof t.headers)for(var c in t.headers)s.setRequestHeader(c,t.headers[c]);s.onreadystatechange=function(e){if(4===s.readyState)if(200===s.status){var r="json"===s.responseType?s.response:s.responseText;"function"==typeof t.success&&t.success(r,s),"function"==typeof t.run&&t.run(r),"function"==typeof t.complete&&t.complete()}else n(t.error,o,[s.status,s]),"function"==typeof t.complete&&t.complete()},s.onerror=function(e){n(t.error,o,[s.status,s]),"function"==typeof t.complete&&t.complete()};try{s.send("?"!==i.substr(0,1)?i:null)}catch(e){console.error("Der skete en fejl med send():\n"+JSON.stringify(e))}}let t=!1;function o(e,o){503!=e||t||(alert("Service Unavailable.\nIt seems like too many licenses are in use"),t=!0),console.error("Fejl i ajax laredo login.js\nStatus code: "+e,o)}function n(e,t,o){"function"==typeof e?e.apply(null,o):t.apply(null,o)}function s(e,t){e=void 0===e?32:e;var o=(t=void 0===t?"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789":t).length-1,n="";if("crypto"in window){var s=new Uint8Array(e);return window.crypto.getRandomValues(s),btoa(s.join(""))}for(var r=0;r<e;r++)n+=t[Math.random()*o];return n}for(var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i="undefined"==typeof Uint8Array?[]:new Uint8Array(256),c=0;c<r.length;c++)i[r.charCodeAt(c)]=c;async function a(e){const t=(new TextEncoder).encode(e),o=await window.crypto.subtle.digest("SHA-256",t),n=function(e){var t,o=new Uint8Array(e),n=o.length,s="";for(t=0;t<n;t+=3)s+=r[o[t]>>2],s+=r[(3&o[t])<<4|o[t+1]>>4],s+=r[(15&o[t+1])<<2|o[t+2]>>6],s+=r[63&o[t+2]];return n%3==2?s=s.substring(0,s.length-1)+"=":n%3==1&&(s=s.substring(0,s.length-2)+"=="),s}(o);return(new TextDecoder).decode(o),n.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}s(128);var h=new class{constructor(e){this.requests=[],this.storageKey="ab-oauth-requests",this.config=e,this.config.token_url||(this.config.token_url=this.config.authorization_url.replace("/authorize","/token")),this.accessToken={access_token:"",expires_in:0,refresh_token:"",scope:"",token_type:"Bearer"},this.load()}get authorization_url(){return this.config.authorization_url}test(){console.log("Tester oauth client"),window.location.hash.indexOf("code=")?this.exchangeAuthCode():this.requestToken("wwapp offline_access")}store(){localStorage.setItem(this.storageKey,JSON.stringify(this.requests))}load(){this.requests=JSON.parse(localStorage.getItem(this.storageKey)||"[]")}requestToken(e){const t=s(16);e=encodeURIComponent(e);let o=encodeURIComponent(this.config.redirect_uri||"");const n=s();this.requests.push({state:t,metadata:{navn:"Michele"},codeVerifier:n}),this.store(),a(n).then((n=>{let s=`${this.config.authorization_url}?`;s+="response_type=code",s+=`&client_id=${this.config.client_id}`,s+=`&redirect_uri=${o}`,s+=`&scope=${e}`,s+=`&state=${t}`,s+=`&code_challenge=${n}`,s+="&code_challenge_method=S256",window.location.href=s}))}exchangeAuthCode(t){t=t||window.location.hash||window.location.search;let o=this.parseHashstring(t),n=o.code,s=o.state,r=this.loadRequest(s);if(r.authorizationCode=n,void 0===r)return console.error(`Missing saved request for state (${s})`,"oauth"),!1;if(this.config.token_url){let t="grant_type=authorization_code";t+=`&client_id=${this.config.client_id}`,t+=`&client_secret=${this.config.client_secret}`,t+=`&redirect_uri=${this.config.redirect_uri}`,t+=`&code=${n}`,t+=`&code_verifier=${r.codeVerifier}`;let o=this,s={method:"POST",formEncoded:!0,success(e){var t=JSON.parse(e);r.accessToken=t,o.accessToken=t}};s.data=t,e(this.config.token_url+"",s)}}getAccessToken(){return this.accessToken.access_token||(this.accessToken=this.findLatestAccessToken()),this.accessToken.access_token||void 0}findLatestAccessToken(){return this.requests.reverse().find((e=>void 0!==e.accessToken&&""!==e.accessToken.access_token)).map((e=>e.accessToken))}parseHashstring(e){let t,o,n=e.split("&"),s={code:"",state:""};for(var r=0;r<n.length;r++)t=n[r].split("="),o=t[0].replace(/^[#\?]/g,""),void 0!==s[o]&&(s[o]=decodeURIComponent(t[1]));return s}loadRequest(e){return this.requests.find((t=>t.state===e))}}({authorization_url:"https://dechiffre.dk/oauth2-demo-php/my-oauth2/authorize.php",token_url:"https://dechiffre.dk/oauth2-demo-php/my-oauth2/token.php",client_id:"localvue",client_secret:"enlang9923123",redirect_uri:"http://localhost:8080/test/index.htm"});confirm("Er du klar?")&&(-1!==window.location.hash.indexOf("code=")||-1!==window.location.search.indexOf("code=")?(h.exchangeAuthCode(),setTimeout((()=>{let t=h.getAccessToken();console.log(t),e("https://dechiffre.dk/oauth2-demo-php/my-oauth2/resource.php",{headers:{Authorization:"Bearer "+t},run(e){console.log("Du har ressourcen: ",e)}})}),3e3)):h.requestToken("testscope"));
